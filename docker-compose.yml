# docker-compose.yml — 백엔드 루트 빌드 + 외부 DB 연결

networks:
  frontend_react_nginx:
  services_backend:
    external: true
  services_frontend:
    external: true

volumes:
  planner-redis-data:
    driver: local
  planner-backend-logs:
    driver: local

services:
  # ────────────────────────────────────────────────
  # 1) NGINX (React 정적 배포)
  # ────────────────────────────────────────────────
  frontend_react_nginx:
    image: nginx:latest
    container_name: planner-nginx
    environment:
      - TZ=Asia/Seoul
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      # ⚠️ React build 결과물 폴더에 맞게 수정 (build 또는 dist)
      - ./frontend/build:/usr/share/nginx/html
      - /etc/localtime:/etc/localtime:ro
    networks:
      - frontend_react_nginx
      - services_frontend
    restart: always
    # ports:
    #   - "80:80"
    #   - "443:443"

  # ────────────────────────────────────────────────
  # 2) Spring Boot Backend
  # ────────────────────────────────────────────────
  planner-backend:
    build:
      context: .              # ✅ 루트 기준으로 빌드
      dockerfile: Dockerfile  # ✅ 루트에 있으므로 명시만
    container_name: planner-backend
    environment:
      - TZ=Asia/Seoul

      # ✅ 외부 DB 연결 (services-db-1)
      - SPRING_DATASOURCE_URL=jdbc:mysql://services-db-1:3306/genius_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=utf8
      - SPRING_DATASOURCE_USERNAME=genius
      - SPRING_DATASOURCE_PASSWORD=genius4MySql!
      - local.db.url=jdbc:mysql://services-db-1:3306/genius_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=utf8

      # ✅ Redis 연결
      - redis.host=planner-redis
      - redis.port=6379

      # ✅ OAuth Redirect (운영 환경)
      - app.oauth2.authorized-redirect-uri=https://plana.hoonee-math.info/auth/callback
      - spring.security.oauth2.client.registration.google.redirect-uri=https://plana.hoonee-math.info/login/oauth2/code/google

      # jWT 시크릿 (값은 ${JWT_SECRET}로 치환)
      - jwt.secret=${JWT_SECRET}
    volumes:
      - planner-backend-logs:/app/logs
      - /etc/localtime:/etc/localtime:ro
    networks:
      - frontend_react_nginx
      - services_backend
      - services_frontend
    restart: always
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8081:8080"

  # ────────────────────────────────────────────────
  # 3) Redis
  # ────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: planner-redis
    environment:
      - TZ=Asia/Seoul
    volumes:
      - planner-redis-data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - frontend_react_nginx
      - services_backend
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
