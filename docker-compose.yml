# docker-compose.yml  â€” ê¸°ì¡´ DB(services-db-1)ì— ì—°ê²° + ê¸°ì¡´ ì˜µì…˜ë“¤ í¬í•¨

networks:
  # ë¡œì»¬ í”„ë¡ íŠ¸-ë¦¬ì•¡íŠ¸-ì—”ì§„ì—‘ìŠ¤ìš© ë„¤íŠ¸ì›Œí¬(ë™ì¼ compose ë‚´)
  frontend_react_nginx:
  # ê¸°ì¡´ ì¸í”„ë¼ ìª½ ë„¤íŠ¸ì›Œí¬ì— ì¡°ì¸ (DBê°€ ë¶™ì–´ìˆëŠ” ë„¤íŠ¸ì›Œí¬)
  services_backend:
    external: true
  # í”„ë¡ íŠ¸ ê³µìš© ë„¤íŠ¸ì›Œí¬ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš© ì¤‘ì´ë©´ ìœ ì§€)
  services_frontend:
    external: true

volumes:
  planner-redis-data:
    driver: local
  planner-backend-logs:
    driver: local

services:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) NGINX (ì •ì  í”„ë¡ íŠ¸)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend_react_nginx:
    image: nginx:latest
    container_name: planner-nginx
    environment:
      - TZ=Asia/Seoul
    volumes:
      # NGINX ì„œë²„ ë¸”ë¡(ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ/ì •ì  ë¼ìš°íŒ… ì„¤ì •)
      - ./nginx/conf.d:/etc/nginx/conf.d
      # ë¹Œë“œëœ í”„ë¡ íŠ¸ì—”ë“œ ì •ì  íŒŒì¼
      - ./frontend:/usr/share/nginx/html
      # (ì„ íƒ) í˜¸ìŠ¤íŠ¸ ì‹œê°„ ë™ê¸°í™”
      - /etc/localtime:/etc/localtime:ro
    networks:
      - frontend_react_nginx
      - services_frontend
    restart: always
    # (ì„ íƒ) ì™¸ë¶€ ë…¸ì¶œ í•„ìš” ì‹œ ì‚¬ìš©
    # ports:
    #   - "80:80"
    #   - "443:443"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) Spring Boot Backend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  planner-backend:
    build: ./backend
    container_name: planner-backend
    environment:
      - TZ=Asia/Seoul

      # âœ… ê¸°ì¡´ DB(services-db-1)ì— ë¶™ë„ë¡ JDBC í˜¸ìŠ¤íŠ¸ë§Œ ì§€ì •
      - SPRING_DATASOURCE_URL=jdbc:mysql://services-db-1:3306/genius_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=utf8
      - SPRING_DATASOURCE_USERNAME=genius
      - SPRING_DATASOURCE_PASSWORD=genius4MySql!

      # (í˜¸í™˜) ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë³„ë„ë¡œ local.db.urlì„ ì½ëŠ” ê²½ìš° ëŒ€ë¹„
      - local.db.url=jdbc:mysql://services-db-1:3306/genius_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=utf8

      # âœ… Redis ì—°ê²° (compose ë‚´ redis ì„œë¹„ìŠ¤)
      - redis.host=planner-redis
      - redis.port=6379

      # âœ… OAuth Redirect (ìš´ì˜ ë„ë©”ì¸ ê¸°ì¤€)
      - app.oauth2.authorized-redirect-uri=https://plana.hoonee-math.info/auth/callback
      - spring.security.oauth2.client.registration.google.redirect-uri=https://plana.hoonee-math.info/login/oauth2/code/google

      # (ì„ íƒ) Spring Profile ì§€ì •ì´ í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ
      # - SPRING_PROFILES_ACTIVE=docker

    volumes:
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ë³´ì¡´
      - planner-backend-logs:/app/logs
      - /etc/localtime:/etc/localtime:ro

    networks:
      - frontend_react_nginx
      - services_backend   # ğŸ”— DBê°€ ë¶™ì–´ìˆëŠ” ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬
      - services_frontend

    restart: always
    depends_on:
      redis:
        condition: service_healthy

    # (ì„ íƒ) ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼/ë””ë²„ê¹…í•  ë•Œë§Œ ì—´ê¸°
    # ë‚´ë¶€ NGINXë§Œ ì‚¬ìš©í•  ê±°ë©´ ìƒëµí•´ë„ ë¨
    ports:
      - "8081:8080"

    # (ì„ íƒ) í—¬ìŠ¤ì²´í¬ â€” ì•¡ì¶”ì—ì´í„°ë¥¼ ì¼œë’€ë‹¤ë©´ ì‚¬ìš©
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 40s

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) Redis
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  redis:
    image: redis:7-alpine
    container_name: planner-redis
    environment:
      - TZ=Asia/Seoul
    volumes:
      - planner-redis-data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - frontend_react_nginx
      - services_backend
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
